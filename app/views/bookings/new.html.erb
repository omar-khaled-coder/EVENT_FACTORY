<div class="container">
    <h1>Create your event</h1>

    <div class="row">
      <!-- Display the space image with the owner's picture overlayed in the lower left corner -->
      <% if @space.images.attached? %>
        <div class="imagewidth position-relative col-12 col-lg-12" style="overflow: hidden;">
          <%= image_tag @space.images.first, class: "img-cover", alt: "Space Image", style: "width: 100%; height: 100%; object-fit: cover;" %>

          <!-- Owner's picture -->
          <div class="owner-picture position-absolute" style="bottom: 10px; right: 20px;">
            <%= image_tag @space.owner.profile_picture, class: "rounded-circle", alt: "Owner Picture", style: "width: 50px; height: 50px; border: 2px solid white;" %>
          </div>
        </div>
      <% end %>
    </div>

    <style>
      .formborders{
       /* border: 2px solid #8080808c;*/
        border-radius: 10px;
        background: #e2e2e299;
        padding: 30px;
        margin-top: 10px;
        box-shadow: 0px 0px 15px;
      }

      .formwidth{
        width: 42%;
        height: 350px;
        margin: 0 auto;

        margin-top: 10px;; /* Center the image horizontally */
      }

      .imagewidth {
        width: 75%; /* 70% width for larger screens */
        height: 350px; /* Let the height adjust automatically */
        margin: 0 auto; /* Center the image horizontally */
        box-shadow: 1px 2px 15px;
        padding: 0px;
        border-radius: 15px;
      }

      @media (max-width: 576px) { /* For small screens like iPhone 12 Pro */
        .imagewidth {
          width: 90%; /* 100% width on small screens */
          height: auto; /* Adjust the height automatically */
        }

        .formwidth {
          width: 97%; /* 100% width on small screens */
          height: auto; /* Adjust the height automatically */
        }
      }
    </style>




    <div class="row formwidth">
      <div class="formborders">
        <%= simple_form_for(@booking) do |f| %>
        <%= f.error_notification %>
  <%= f.error_notification message: f.object.errors[:base].to_sentence if f.object.errors[:base].present? %>

          <div class="form-inputs col-12 col-lg-12"">
            <%= f.input :space_id, as: :hidden %>
            <%= f.input :start_date, as: :string, label: "Booking Date", input_html: { readonly: true } %>
            <%= f.input :start_hour, as: :select, collection: generate_time_options(@space.available_from, @space.available_to).map { |time| [time.strftime("%I:%M %p"), time.strftime("%H:%M")] }, label: "Start Time", input_html: { id: "start_time" } %>
            <%= f.input :end_hour, as: :select, collection: generate_time_options(@space.available_from, @space.available_to).map { |time| [time.strftime("%I:%M %p"), time.strftime("%H:%M")] }, label: "End Time", input_html: { id: "end_time" } %>
           <div class="field">
              <%= f.label :guest_number, "Number of Guests" %>
              <%= f.number_field :guest_number, min: 1, max: @space.capacity, id: "guest_number" %>
              <span id="guest_number_error" style="color: red; font-size: 0.9em;"></span>
            </div>

            <div class="field">
              <%= f.label :event_type, "Event Type" %>
              <%= f.select :event_type, options_for_select(@space.space_type.reject(&:blank?)) %>
            </div>

            <hr>

          </div>

          <div id="price-calculation" style="font-family: sans-serif;color: #000000d6;font-size: 1rem;display: grid;grid-template-columns: 1fr auto;font-weight: 550 !important;">
            <!-- Calculated price will be displayed here -->
          </div>

          <!-- Hidden field to store the calculated price -->
          <%= f.hidden_field :price, id: "booking_price" %>

          <hr>

          <div class="field <%= 'field_with_errors' if f.object.errors[:responsibility].present? %>">
            <%= f.check_box :responsibility, required: true %>
            <%= f.label :responsibility, "By booking this space I confirm that I am solely responsible for adhering to state and local regulations regarding COVID-19 policies when visiting or using this space." %>

            <!-- Display the specific error message next to the checkbox -->
            <% if f.object.errors[:responsibility].present? %>
              <div class="error_message" style="color: red;">
                <%= f.object.errors[:responsibility].first %>
              </div>
            <% end %>
          </div>

          <div class="form-actions" style="justify-content: space-evenly;display: flex;">
            <%= f.submit "Send Booking Request",class:"btn btn-warning" %>
          </div>
        <% end %>
        </div>

        <br>

        <div>
         <%= link_to "Back to Space", space_path(@space) %>

        </div>
    </div>
</div>


<!-- JavaScript for Price Calculation -->
<script>
  const guestNumberInput = document.getElementById("guest_number");
  const guestNumberError = document.getElementById("guest_number_error");
  const maxCapacity = <%= @space.capacity %>;
  const minCapacity = 1;

  guestNumberInput.addEventListener("input", function() {
    let value = parseInt(this.value);

    if (value > maxCapacity) {
      guestNumberError.textContent = `The number of guests cannot exceed ${maxCapacity}.`;
      this.value = maxCapacity;
    } else if (value < minCapacity) {
      guestNumberError.textContent = `The number of guests cannot be less than ${minCapacity}.`;
      this.value = minCapacity;
    } else {
      guestNumberError.textContent = ''; // Clear the error message if within the valid range
    }
  });


    function calculatePrice() {
      const startTime = document.getElementById("start_time").value;
      const endTime = document.getElementById("end_time").value;
      const pricePerHour = <%= @space.price_per_hour %>;
      const minHours = <%= @space.minimum_rental_duration %>;

      if (startTime && endTime) {
        const start = new Date(`1970-01-01T${startTime}:00`);
        const end = new Date(`1970-01-01T${endTime}:00`);
        const hours = (end - start) / (1000 * 60 * 60);

        const calculatedHours = hours < minHours ? minHours : hours;
        const spacePrice = pricePerHour * calculatedHours;
        const estimatedPrice = spacePrice; // Add any additional fees here if necessary

        // Update the price display
        document.getElementById("price-calculation").innerHTML = `
          <p>Space price: $ ${pricePerHour} x ${calculatedHours} hrs: </p> <p>$ ${spacePrice.toFixed(2)}</p>
          <p>Estimated price: </p> <p> $ ${estimatedPrice.toFixed(2)}</p>
        `;

        // Set the hidden price field value
        document.getElementById("booking_price").value = estimatedPrice.toFixed(2);
      }
    }

    // Attach event listeners
    document.getElementById("start_time").addEventListener("change", calculatePrice);
    document.getElementById("end_time").addEventListener("change", calculatePrice);

    // Call the calculation function immediately after the page loads
    calculatePrice();

</script>
