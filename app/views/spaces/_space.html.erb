<script>
document.addEventListener('DOMContentLoaded', () => {
  const thumbnails = document.querySelectorAll('.thumbnail');
  const carousel = document.querySelector('#carouselExample');
  const bootstrapCarousel = new bootstrap.Carousel(carousel);

  thumbnails.forEach((thumbnail, index) => {
    thumbnail.addEventListener('click', (event) => {
      // Remove active class from all thumbnails
      thumbnails.forEach(thumbnail => thumbnail.classList.remove('active'));

      // Add active class to the clicked thumbnail
      event.currentTarget.classList.add('active');

      // Move the carousel to the clicked image
      bootstrapCarousel.to(index);
    });
  });

  carousel.addEventListener('slid.bs.carousel', (event) => {
    // Remove active class from all thumbnails
    thumbnails.forEach(thumbnail => thumbnail.classList.remove('active'));

    // Add active class to the current thumbnail
    thumbnails[event.to].classList.add('active');
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const availableDays = document.querySelectorAll('.available-day');

  availableDays.forEach(day => {
    day.addEventListener('click', (event) => {
      event.preventDefault();
      const selectedDate = day.getAttribute('data-date');
      document.getElementById('selected_date').value = selectedDate;
    });
  });
});
document.addEventListener("DOMContentLoaded", function() {
  const datePicker = document.querySelector(".date-picker");
  datePicker.addEventListener("change", function(event) {
    const selectedDate = event.target.value;
    // Perform an action with the selected date, such as sending an AJAX request
  });
});
document.addEventListener("DOMContentLoaded", function() {
  flatpickr(".date-picker", {
    minDate: "today", // Disables past dates
    maxDate: "<%= @space.end_date %>", // Set maximum date from your database
    dateFormat: "Y-m-d", // Format for the date
    altInput: true, // Use a more human-friendly input format
    altFormat: "F j, Y", // The format of the alternative input
  });
});

 function calculatePrice() {
    const startTime = document.getElementById("start_time").value;
    const endTime = document.getElementById("end_time").value;
    const pricePerHour = <%= @space.price_per_hour %>;
    const minHours = <%= @space.minimum_rental_duration %>;

    if (startTime && endTime) {
      const start = new Date(`1970-01-01T${startTime}:00`);
      const end = new Date(`1970-01-01T${endTime}:00`);
      const hours = (end - start) / (1000 * 60 * 60);

      const calculatedHours = hours < minHours ? minHours : hours;
      const spacePrice = pricePerHour * calculatedHours;
      const estimatedPrice = spacePrice + 0; // Add additional fees if any

      document.getElementById("price-calculation").innerHTML = `
    <p>Space price: $ ${pricePerHour} x ${calculatedHours} hrs: </p> <p>$ ${spacePrice.toFixed(2)}</p>
<p>Estimated price: </p> <p> $ ${estimatedPrice.toFixed(2)}</p>

      `;
    }
  }

  function validateGuests() {
  const guestInput = document.getElementById("guest_number");
  const maxGuests = guestInput.max;
  const guestError = document.getElementById("guest-error");

  if (parseInt(guestInput.value) > parseInt(maxGuests)) {
    guestError.style.display = "block";
    guestInput.value = maxGuests;
  } else {
    guestError.style.display = "none";
  }
}

</script>



<div class="container">
  <!--<div id="<%= dom_id(@space) %>" class="space-images row">
    <% if @space.images.attached? %>
      <div class="large-image">
        <%= image_tag @space.images.first, id: "current-image", class: "current-image" %>
      </div>
      <div class="thumbnail-images">
        <% @space.images.each_with_index do |image, index| %>
          <%= image_tag image, class: "thumbnail #{'active' if index == 0}", data: { large_image: url_for(image), index: index } %>
        <% end %>
      </div>
      <div class="image-nav">
        <a href="javascript:void(0)" class="prev" onclick="changeImage(-1)">&#10094;</a>
        <a href="javascript:void(0)" class="next" onclick="changeImage(1)">&#10095;</a>
      </div>
    <% end %>
  </div>-->
  <div id="carouselExample" class="carousel slide" > <!-- 5000ms = 5 seconds OR use data-bs-ride="carousel" to make it change automatic -->
    <div class="carousel-inner">
      <% @space.images.each_with_index do |image, index| %>
        <div class="carousel-item <%= 'active' if index == 0 %>">
          <%= image_tag url_for(image), class: "d-block w-100 carousel-image", alt: "Space Image" %>
        </div>
      <% end %>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

<div class="thumbnail-images d-flex justify-content-center flex-wrap mt-2">
    <% @space.images.each_with_index do |image, index| %>
      <%= image_tag url_for(image), class: "thumbnail #{'active' if index == 0}", data: { bs_target: '#carouselExample', bs_slide_to: index } %>
    <% end %>
  </div>

  <div class="row content-section">
    <div class="col-12 col-lg-6">
      <!-- Space details... -->
      <div class="space-title row">
            <%= space.title %>
      </div>

    <p>
      <%= space.city%> | <%= space.state %>| <%= country_name(space.country) %>
    </p>

    <div class="space-type-container">

      <% space.space_type.reject(&:blank?).each do |type| %>
        <div class="space-type-item">
          <i class="<%= icon_for_space_type(type) %>"></i>
          <span><%= type %></span>
        </div>
      <% end %>

    </div>


    <hr>

<div class="hosted-by-container">
  <div class="hosted-by-info">
      <%= image_tag space.owner.profile_picture, class: "avatar-show" %>
    <h5>Hosted by | <%= space.owner.first_name %></h5>
  </div>

  <%= button_to "Message Owner", chatrooms_path(chatroom: { user_id: current_user.id, owner_id: @space.owner.id, space_id: @space.id }), method: :post, class: "btn btn-primary" %>
</div>

<style>
  .hosted-by-container {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
      justify-content: space-between;
  }

  .avatar-show {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
  }

  .hosted-by-info {
    display: flex;
    align-items: center;
  }

  .hosted-by-info h5 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: bold;
    margin-right: 15px;
  }

  .btn-primary {
    padding: 8px 15px;
    background-color: #007bff;
    border: none;
    border-radius: 5px;
    color: white;
    text-decoration: none;
    transition: background-color 0.3s ease;
  }

  .btn-primary:hover {
    background-color: #0056b3;
  }
</style>


    <hr>

    <div class=" row" >
      <p class="space-title">The Space:</p>
      <p style="font-size: 18px;white-space: pre-line;color: #606060;"><%= space.description %><p>
    </div>


    <hr style="margin-top: 0;">

    <div >

      <div style="display: flex;justify-content: space-around;">

          <div class="capacity-display">
            <i class="fas fa-users"></i>
            <span><%= space.capacity %> MAX</span>
            <!-- Use "fa-light fa-users" if you have access to FontAwesome Pro -->
          </div>


          <div class="houres">
            <i class="fas fa-clock"></i> <!-- Assuming you have an icon for the duration -->
            <span><%= space.minimum_rental_duration %> hrs minimum</span>
          </div>

      </div>

    </div>

    <hr>

    <div>

      <strong>Amenities:</strong>

      <ul class="amenities-list ">
        <% space.amenities.split(/\r?\n/).map(&:strip).each do |amenity| %>
          <li>
            <i class="<%= icon_for_amenity(amenity) %>"></i>
            <span><%= amenity.capitalize %></span>
          </li>
        <% end %>
      </ul>

    </div>

    <hr>

    <div >

          <p>
            <strong>Address:</strong>
            <%= space.address %>
          </p>

          <div>

              <div id="map_show"
                data-controller="map"
                      data-map-marker-value="<%= @marker.to_json %>"
                data-map-api-key-value="<%= ENV['GOOGLE_API_BROWSER_KEY'] %>"
                style="width: 100%; height: 400px;">
              </div>

          </div>

    </div>

    <hr>
<div>
  <h3>Reviews</h3>
  <% if @space.reviews.any? %>
    <p>Average Rating: <%= @space.reviews.average(:rating).round(2) %></p>

    <% @space.reviews.each do |review| %>
      <div class="review-item">
        <!-- User Info with Avatar, Name, and Account Age -->
        <div class="user-info">
          <%= image_tag review.user.profile_picture.attached? ? review.user.profile_picture : 'default-avatar.png', class: "user-avatar", alt: "User Avatar" %>
          <div>
            <strong><%= review.user.first_name %></strong>
            <span class="user-created-at">- Member since <%= review.user.created_at.strftime("%B %Y") %></span>
          </div>
        </div>

        <!-- Star Rating with Review Date -->
        <div class="star-rating">
          <% review.rating.times do %>
            <span class="star">&#9733;</span> <!-- Filled star -->
          <% end %>
          <% (5 - review.rating).times do %>
            <span class="star">&#9734;</span> <!-- Empty star -->
          <% end %>

          <span class="review-date">- Reviewed on <%= review.created_at.strftime("%B %d, %Y") %></span>
        </div>

        <!-- Review Comment -->
        <p class="review-comment"><%= review.comment %></p>
      </div>
      <hr>
    <% end %>
  <% else %>
    <p>No reviews yet.</p>
  <% end %>
</div>

<style>
  .review-item {
    display: flex;
    flex-direction: column;
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .user-info {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
  }

  .user-info div {
    display: flex;
    flex-direction: column;
  }

  .user-created-at {
    font-size: 0.85rem;
    color: #666;
  }

  .star-rating {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }

  .star-rating .star {
    color: #ffcc00;
    font-size: 20px;
  }

  .review-date {
    font-size: 0.85rem;
    color: #999;
    margin-left: 10px;
  }

  .review-comment {
    font-size: 1rem;
    color: #333;
    margin-left: 50px;
  }
</style>

    </div>


    <!-- Form Section -->
<div class="form-section col-12 col-lg-6">
  <%= form_with url: new_booking_path, method: :get, local: true do %>
<div style="display: flex; align-items: last baseline;">
 <h3 style="font-family: initial;">
  <span class="currency-symbol"><%= @space.price_per_hour.currency.symbol %></span>
  <span class="price-amount"><%= @space.price_per_hour.format(symbol: false) %></span>
</h3>

  <h6 style="color: #383838ab; font-style: italic;">
    Per Hour (Min. <%= @space.minimum_rental_duration %> hr)
  </h6>
</div>


    <div class="field">
      <label for="start_time">Start Time</label>
      <select id="start_time" name="start_time" onchange="calculatePrice()">
        <% generate_time_options(@space.available_from, @space.available_to).each do |time| %>
          <option value="<%= time.strftime("%H:%M") %>"><%= time.strftime("%I:%M %p") %></option>
        <% end %>
      </select>
    </div>

    <div class="field">
      <label for="end_time">End Time</label>
      <select id="end_time" name="end_time" onchange="calculatePrice()">
        <% generate_time_options(@space.available_from, @space.available_to).each do |time| %>
          <option value="<%= time.strftime("%H:%M") %>"><%= time.strftime("%I:%M %p") %></option>
        <% end %>
      </select>
    </div>

    <div class="field">
      <label for="guest_number">Number of Guests</label>
      <input type="number" id="guest_number" name="guest_number" min="1" max="<%= @space.capacity %>" oninput="validateGuests()">
      <small id="guest-error" style="color: red; display: none;">The number of guests cannot exceed the capacity of <%= @space.capacity %> guests.</small>
    </div>

    <div class="date-selection">
      <label for="booking_date" class="date-label">Select Booking Date:</label>
      <input type="text" id="booking_date" name="booking_date" class="date-picker">
    </div>

    <!-- Hidden fields to pass data to the new booking page -->
    <%= hidden_field_tag :space_id, @space.id %>
    <%= hidden_field_tag :hidden_start_time, nil, id: 'hidden_start_time' %>
    <%= hidden_field_tag :hidden_end_time, nil, id: 'hidden_end_time' %>
    <%= hidden_field_tag :hidden_guest_number, nil, id: 'hidden_guest_number' %>
    <%= hidden_field_tag :hidden_booking_date, nil, id: 'hidden_booking_date' %>


    <hr>
    <div id="price-calculation" style="font-family: sans-serif;color: #000000d6;font-size: 1rem;display: grid;grid-template-columns: 1fr auto;font-weight: 550 !important;">
      <!-- Calculated price will be displayed here -->
    </div>
    <hr>

    <%= submit_tag 'Proceed to Confirmation', class: 'btn btn-info' %>
  <% end %>
</div>


  </div>
</div>

<%= session[:currency] %>




 <!--<div class="field">
        <label for="start_time">Start Time</label>
        <select id="start_time" name="start_time">
          <% generate_time_options(@space.available_from, @space.available_to).each do |time| %>
            <option value="<%= time.strftime("%H:%M") %>"><%= time.strftime("%I:%M %p") %></option>
          <% end %>
        </select>
      </div>

      <div class="field">
        <label for="end_time">End Time</label>
        <select id="end_time" name="end_time">
          <% generate_time_options(@space.available_from, @space.available_to).each do |time| %>
            <option value="<%= time.strftime("%H:%M") %>"><%= time.strftime("%I:%M %p") %></option>
          <% end %>
        </select>
      </div>

   <%= month_calendar do |date| %>
          <% if @space.start_date <= date && @space.end_date >= date && date >= Date.today %>
            <%= link_to date.day, "select_date_path(date: date, space_id: @space.id)", class: 'available-day' %>
          <% else %>
            <span><%= date.day %></span>
          <% end %>
        <% end %> -->
